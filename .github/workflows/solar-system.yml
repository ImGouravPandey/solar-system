name: Solar System Workflow

on:
  push:
    branches:
      - main
      - 'feature/*'
  workflow_dispatch:

env:
  MONGO_URI: 'mongodb+srv://supercluster.d83jj.mongodb.net/superData'
  MONGO_USERNAME: ${{ vars.MONGO_USERNAME }}
  MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}

jobs:
  unit-testing:
    name: Unit Testing
    strategy:
      matrix: 
        nodejs_version: [18,19] # 20]
        operating_system: [ubuntu-latest] #macos-latest]
        # exclude:
        #   - nodejs_version: 18
        #     operating_system: macos-latest   
    runs-on: ${{ matrix.operating_system }}    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js - ${{ matrix.nodejs_version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.nodejs_version }}

      - name: Install Dependencies
        run: npm install

      - name: Run Tests
        id: nodejs-unit-testing-step #added this specific id so if something  fails it can be referenced in the next step
        run: npm test

      - name: Archive Test Result
        if: always()
          # failure() && (steps.nodejs-unit-testing-step.outcome == 'failure' || steps.nodejs-unit-testing-step.outcome == 'success')
          # if something breaks at the unit test, this will keep it running 
        uses: actions/upload-artifact@v3
        with: 
          name: mocha-test-result
          path: test-results.xml

# if: steps.nodejs-unit-testing-step.outcome == 'failure' || steps.nodejs-unit-testing-step.outcome == 'success' if it is still giving error, its because of status(), a default status check of success is applied unless you include one of these function, check status check function documentation, here for test im using failure, now even the unit test breaks archive step will run, but if we fixed the error, the if line will skip, thats why im using always() so it always execute even if the previous steps fails or pass

  code-coverage: 
    name: code coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
          
      - name: Setup Node.js Version 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
          
      - name: Install Dependencies
        run: npm install
          
      - name: Check Code Coverage
        continue-on-error:  true # don't fail the action if there is no code to cover
        run: npm run coverage
          
      - name: Archive Code Coverage Result
        uses: actions/upload-artifact@v3
        with:
          name: code coverage result
          path: coverage
          retention-days: 5
